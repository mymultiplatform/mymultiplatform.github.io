<!DOCTYPE html>
<html>
<head>
    <title>Rentas Sanchez - Landlord App</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; background:#f3f3f3; padding:20px; }
        h1 { color:#333; }
        #tenantTable { width:100%; border-collapse: collapse; margin-top:20px; }
        #tenantTable th, #tenantTable td {
            border:1px solid #aaa; padding:8px; text-align:left;
        }
        #tenantTable th { background:#ddd; }
        .upload-box {
            border:2px dashed #888; padding:20px; width:300px;
            background:white; cursor:pointer; margin-bottom:20px;
        }
        .plus-btn {
            font-size:30px; font-weight:bold;
            background:#4CAF50; color:white; padding:10px 20px;
            border:none; border-radius:5px; cursor:pointer;
        }
    </style>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>

<body>

<h1>üè† Rentas Sanchez ‚Äî Landlord Dashboard</h1>

<p>Upload a .txt contract to auto-create a new tenant profile.</p>

<!-- plus button -->
<button class="plus-btn" onclick="document.getElementById('fileInput').click()">+ Add New Contract</button>

<input type="file" id="fileInput" accept=".txt,.pdf" style="display:none">

<div id="output"></div>

<table id="tenantTable">
    <thead>
        <tr>
            <th>Tenant Name</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Monthly Rent</th>
            <th>Rent Due Day</th>
        </tr>
    </thead>
    <tbody id="tenantBody">
    </tbody>
</table>


<script>
// Listen for contract file upload
document.getElementById("fileInput").addEventListener("change", function() {
    const file = this.files[0];
    if (!file) return;

    const ext = (file.name.split(".").pop() || "").toLowerCase();

    // Reset so user can upload the same file again
    this.value = "";

    if (ext === "txt") {
        const reader = new FileReader();
        reader.onload = function(e) {
            handleContractText(e.target.result);
        };
        reader.readAsText(file);
        return;
    }

    if (ext === "pdf") {
        const reader = new FileReader();

        reader.onload = async function(e) {
            try {
                // Important for pdf.js worker
                pdfjsLib.GlobalWorkerOptions.workerSrc =
                    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

                const typedArray = new Uint8Array(e.target.result);
                const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;

                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const strings = content.items.map(item => item.str);
                    fullText += strings.join(" ") + "\n";
                }

                handleContractText(fullText);
            } catch (err) {
                document.getElementById("output").innerHTML =
                    "<h3>Error reading PDF:</h3><pre>" + (err && err.message ? err.message : err) + "</pre>";
            }
        };

        reader.readAsArrayBuffer(file);
        return;
    }

    document.getElementById("output").innerHTML =
        "<h3>Unsupported file type:</h3><pre>Please upload a .txt or .pdf file.</pre>";
});

function handleContractText(text) {
    // DISPLAY RAW TEXT FOR DEBUGGING (same behavior you had)
    document.getElementById("output").innerHTML =
        "<h3>Parsed Contract Text:</h3><pre>" + text + "</pre>";

    // --- SPANISH CONTRACT EXTRACTION LOGIC (matches your PDF format) ---

    // ARRENDATARIO: NAME...
    const tenantMatch = text.match(/ARRENDATARIO:\s*([A-Z√Å√â√ç√ì√ö√ë\s]+?)(?:\s+ACEPTANDO|\s+CL√ÅUSULAS:|\n|$)/i);

    // "a partir del d√≠a 3 de Marzo del 2024"
    const startMatch  = text.match(/a partir del d√≠a\s+(\d{1,2}\s+de\s+[A-Za-z√Å√â√ç√ì√ö√±]+\s+del\s+\d{4})/i);

    // "hasta el d√≠a 3 de Septiembre de 2024"  (sometimes "del", sometimes "de")
    const endMatch    = text.match(/hasta el d√≠a\s+(\d{1,2}\s+de\s+[A-Za-z√Å√â√ç√ì√ö√±]+\s+(?:del|de)\s+\d{4})/i);

    // Rent formats seen:
    // - "ser√° de 4,000.00 pesos"
    // - "ser√° de $500 usd d√≥lares estadounidenses"
    // - could also appear as "ser√° de $ 4,000.00"
    const rentMatch = text.match(/precio del arrendamiento ser√° de\s+(\$?\s*[\d.,]+(?:\s*(?:pesos|usd|d√≥lares|dolares))?)/i);

    const tenantName = tenantMatch ? tenantMatch[1].replace(/\s+/g, " ").trim() : "Not found";
    const startDate  = startMatch ? startMatch[1].replace(/\s+/g, " ").trim() : "Not found";
    const endDate    = endMatch ? endMatch[1].replace(/\s+/g, " ").trim() : "Not found";
    const rentAmount = rentMatch ? rentMatch[1].replace(/\s+/g, " ").trim() : "Not found";

    // Your PDF format doesn't explicitly state a numeric "due day", it states monthly advance payment
    const dueDay = "Mensual por adelantado";

    // Add row to table
    const row = `
        <tr>
            <td>${tenantName}</td>
            <td>${startDate}</td>
            <td>${endDate}</td>
            <td>${rentAmount}</td>
            <td>${dueDay}</td>
        </tr>
    `;

    document.getElementById("tenantBody").innerHTML += row;
}
</script>

</body>
</html>
