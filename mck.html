<script>
const sheetW = 2440;
const sheetH = 1220;

const parts = [
  {w:800, h:400, q:2},
  {w:600, h:300, q:4},
  {w:1200, h:200, q:1},
];

function expand(parts){
  return parts.flatMap(p =>
    Array.from({length:p.q}, ()=>({w:p.w,h:p.h}))
  );
}

// sort largest first (area)
function sortRects(r){
  return r.sort((a,b)=>(b.w*b.h)-(a.w*a.h));
}

function nest(rects){
  const sheets=[];

  rects.forEach(r=>{
    let placed=false;

    for(const sheet of sheets){
      if(placeOnSheet(sheet,r)){
        placed=true;
        break;
      }
    }

    if(!placed){
      const s=[];
      placeOnSheet(s,r);
      sheets.push(s);
    }
  });

  return sheets;
}

function placeOnSheet(sheet,r){
  const spots = candidateSpots(sheet);

  for(const {x,y} of spots){
    if(fits(sheet,x,y,r.w,r.h)){
      sheet.push({x,y,w:r.w,h:r.h});
      return true;
    }
    // try rotation
    if(fits(sheet,x,y,r.h,r.w)){
      sheet.push({x,y,w:r.h,h:r.w});
      return true;
    }
  }
  return false;
}

function candidateSpots(sheet){
  const pts=[{x:0,y:0}];

  sheet.forEach(p=>{
    pts.push({x:p.x+p.w, y:p.y});
    pts.push({x:p.x, y:p.y+p.h});
  });

  return pts;
}

function fits(sheet,x,y,w,h){
  if(x+w>sheetW || y+h>sheetH) return false;

  return !sheet.some(p=>
    x < p.x+p.w &&
    x+w > p.x &&
    y < p.y+p.h &&
    y+h > p.y
  );
}

function draw(sheets){
  const out=document.getElementById("out");
  out.innerHTML="Sheets used: "+sheets.length;

  sheets.forEach(s=>{
    const c=document.createElement("canvas");
    c.width=sheetW/4;
    c.height=sheetH/4;
    const ctx=c.getContext("2d");
    ctx.scale(0.25,0.25);

    ctx.fillStyle="#eee";
    ctx.fillRect(0,0,sheetW,sheetH);

    s.forEach(p=>{
      ctx.fillStyle=`hsl(${Math.random()*360},70%,60%)`;
      ctx.fillRect(p.x,p.y,p.w,p.h);
      ctx.strokeRect(p.x,p.y,p.w,p.h);
    });

    out.appendChild(c);
  });
}

function run(){
  const rects = sortRects(expand(parts));
  const sheets = nest(rects);
  draw(sheets);
}
</script>
